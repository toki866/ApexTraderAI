name: Run Desktop Pipeline

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Pipeline mode (sim/live/display)"
        required: true
        default: sim
        type: choice
        options:
          - sim
          - live
          - display
      symbols:
        description: "Symbols for data preparation (comma-separated)"
        required: true
        default: "SOXL,SOXS"
        type: string
      start:
        description: "Data start date (YYYY-MM-DD)"
        required: true
        default: "2014-01-01"
        type: string
      end:
        description: "Data end date (YYYY-MM-DD)"
        required: true
        default: "2022-03-31"
        type: string
      test_start:
        description: "Test start date (YYYY-MM-DD)"
        required: true
        default: "2022-01-03"
        type: string
      train_years:
        description: "Train years"
        required: true
        default: "8"
        type: string
      test_months:
        description: "Test months"
        required: true
        default: "3"
        type: string
      copy_to_onedrive:
        description: "Copy run outputs to OneDrive (1=true, 0=false)"
        required: true
        default: true
        type: boolean
      steps:
        description: "Pipeline steps (comma-separated)"
        required: true
        default: "A,B"
        type: string

concurrency:
  group: diag-logs
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: [self-hosted, windows]
    steps:
      - name: Resolve repo root
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          $repoRoot = $null
          $workspaceBat = Join-Path $env:GITHUB_WORKSPACE 'scripts\run_all_local_then_copy.bat'

          if (Test-Path $workspaceBat) {
            $repoRoot = $env:GITHUB_WORKSPACE
          } else {
            $bat = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter 'run_all_local_then_copy.bat' -File -ErrorAction SilentlyContinue |
              Select-Object -First 1
            if ($bat) {
              $scriptsDir = Split-Path $bat.FullName -Parent
              $repoRoot = Split-Path $scriptsDir -Parent
            }
          }

          if (-not $repoRoot) {
            Write-Host "Could not resolve REPO_ROOT under GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
            Write-Host '=== Top-level listing of GITHUB_WORKSPACE ==='
            Get-ChildItem -Path $env:GITHUB_WORKSPACE -Force | Select-Object FullName, Name, Mode, LastWriteTime | Format-Table -AutoSize
            throw "Unable to locate scripts\\run_all_local_then_copy.bat under GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          }

          Add-Content -Path $env:GITHUB_ENV -Value "REPO_ROOT=$repoRoot"
          Write-Host "REPO_ROOT=$repoRoot"

      - name: Sync repo to github.sha (no delete)
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          GIT_TERMINAL_PROMPT: "0"
        run: |
          $ErrorActionPreference = 'Stop'
          function Assert-Ok($msg) { if ($LASTEXITCODE -ne 0) { throw "$msg (exit=$LASTEXITCODE)" } }

          $repo = "$env:REPO_ROOT"
          Set-Location $repo

          git config --global core.longpaths true
          Assert-Ok 'git config core.longpaths failed'
          git config --global --add safe.directory "$repo"
          Assert-Ok 'git config safe.directory failed'

          if (!(Test-Path (Join-Path $repo '.git'))) {
            git init
            Assert-Ok 'git init failed'
            git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
            Assert-Ok 'git remote add origin failed'
          } else {
            git remote get-url origin *> $null
            if ($LASTEXITCODE -ne 0) {
              git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
              Assert-Ok 'git remote add origin failed'
            } else {
              git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
              Assert-Ok 'git remote set-url failed'
            }
          }

          git fetch --force --prune origin
          Assert-Ok 'git fetch failed'
          git fetch --force origin $env:GITHUB_SHA
          Assert-Ok 'git fetch SHA failed'

          $shaScripts = git ls-tree -r --name-only $env:GITHUB_SHA -- scripts
          Assert-Ok 'git ls-tree failed'
          if ($shaScripts) {
            Write-Host 'git ls-tree scripts (for GITHUB_SHA):'
            $shaScripts | ForEach-Object { Write-Host "  $_" }
          } else {
            Write-Warning 'Current SHA has no scripts folder; run is on an old commit or scripts not committed.'
          }

          git checkout -f $env:GITHUB_SHA
          Assert-Ok 'git checkout failed'
          git reset --hard $env:GITHUB_SHA
          Assert-Ok 'git reset failed'
          git clean -ffdx
          Assert-Ok 'git clean failed'
          if (Test-Path (Join-Path $repo '.gitmodules')) {
            git submodule update --init --recursive
            Assert-Ok 'git submodule update failed'
          }
          git rev-parse HEAD
          Assert-Ok 'git rev-parse failed'

      - name: Debug shells
        continue-on-error: true
        shell: cmd
        run: |
          echo RUNNER_OS=%RUNNER_OS%
          echo === powershell path ===
          where powershell >nul 2>&1
          if %ERRORLEVEL% EQU 0 (
            where powershell
          ) else (
            echo powershell_not_found
          )
          echo === pwsh path (optional) ===
          where pwsh >nul 2>&1
          if %ERRORLEVEL% EQU 0 (
            pwsh -v
          ) else (
            echo pwsh_not_found (OK)
          )
          exit /b 0

      - name: Debug python environment
        shell: cmd
        run: |
          where python
          python --version
          echo RUNNER_TEMP=%RUNNER_TEMP%
          echo GITHUB_WORKSPACE=%GITHUB_WORKSPACE%

      - name: Resolve REPO_ROOT
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          $repoRoot = $env:GITHUB_WORKSPACE
          $bat = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter 'run_all_local_then_copy.bat' -File -ErrorAction SilentlyContinue |
            Select-Object -First 1

          if ($bat) {
            $scriptsDir = Split-Path $bat.FullName -Parent
            $repoRoot = Split-Path $scriptsDir -Parent
            Write-Host "Resolved run_all_local_then_copy.bat at: $($bat.FullName)"
          } else {
            Write-Warning "Could not find scripts\\run_all_local_then_copy.bat under GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
            Write-Host "Falling back REPO_ROOT to GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          }

          Add-Content -Path $env:GITHUB_ENV -Value "REPO_ROOT=$repoRoot"
          Write-Host "REPO_ROOT=$repoRoot"

      - name: Verify required scripts
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          Set-Location $env:REPO_ROOT

          $reportDir = Join-Path $env:REPO_ROOT 'temp'
          $null = New-Item -Path $reportDir -ItemType Directory -Force
          $reportPath = Join-Path $reportDir 'ONE_TAP_ERROR_REPORT.txt'

          @(
            '=== ONE TAP ERROR REPORT ===',
            ('timestamp={0}' -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz')),
            ('repo=${{ github.repository }}'),
            ('ref=${{ github.ref }}'),
            ('sha=${{ github.sha }}'),
            ('run_id=${{ github.run_id }}'),
            ('run_attempt=${{ github.run_attempt }}'),
            ('failing_step=Verify required scripts'),
            ('REPO_ROOT={0}' -f $env:REPO_ROOT),
            ('GITHUB_WORKSPACE={0}' -f $env:GITHUB_WORKSPACE),
            ('PWD={0}' -f $PWD),
            ''
          ) | Set-Content -Path $reportPath -Encoding UTF8

          Write-Host '=== Verify scripts directory ==='
          Write-Host "REPO_ROOT=$env:REPO_ROOT"
          $headShort = git rev-parse --short HEAD 2>$null
          if ($LASTEXITCODE -eq 0 -and $headShort) {
            Write-Host ("HEAD={0}" -f $headShort.Trim())
          } else {
            Write-Warning 'Unable to resolve HEAD via git rev-parse --short HEAD'
          }
          Write-Host 'git ls-files scripts (best effort):'
          git ls-files scripts 2>$null
          $scriptsDir = Join-Path $env:REPO_ROOT 'scripts'
          Write-Host "scripts_dir=$scriptsDir"
          if (Test-Path $scriptsDir) {
            Get-ChildItem -Path $scriptsDir | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          } else {
            Write-Warning "scripts directory not found: $scriptsDir"
          }

          $expected = @(
            (Join-Path $env:REPO_ROOT 'scripts\run_all_local_then_copy.bat'),
            (Join-Path $env:REPO_ROOT 'scripts\package_diagnostics.ps1'),
            (Join-Path $env:REPO_ROOT 'scripts\package_diagnostics_to_onedrive.ps1')
          )

          $missing = @()
          foreach ($path in $expected) {
            if (Test-Path $path) {
              Write-Host "[FOUND] $path"
            } else {
              Write-Warning "[MISSING] $path"
              $missing += $path
            }
          }

          $searchResults = [ordered]@{}
          foreach ($fileName in @('run_all_local_then_copy.bat', 'package_diagnostics.ps1', 'package_diagnostics_to_onedrive.ps1')) {
            $hits = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter $fileName -File -ErrorAction SilentlyContinue |
              Select-Object -First 5 -ExpandProperty FullName
            $searchResults[$fileName] = if ($hits) { $hits } else { @('(no matches)') }
          }

          Add-Content -Path $reportPath -Value @(
            '## REQUIRED_SCRIPT_CHECK',
            ('repo_root={0}' -f $env:REPO_ROOT),
            ('scripts_dir_exists={0}' -f (Test-Path $scriptsDir)),
            ('scripts_dir={0}' -f $scriptsDir),
            '',
            '### scripts_dir_listing',
            $(
              if (Test-Path $scriptsDir) {
                $listing = Get-ChildItem -Path $scriptsDir | Sort-Object Name | ForEach-Object {
                  '- {0} | len={1} | mtime={2}' -f $_.Name, $_.Length, $_.LastWriteTime
                }
                if ($listing) { $listing } else { '- (empty)' }
              } else {
                '- (scripts directory missing)'
              }
            ),
            '',
            '### FOUND',
            ($expected | Where-Object { Test-Path $_ } | ForEach-Object { "- $_" }),
            '',
            '### MISSING',
            ($(if ($missing.Count -gt 0) { $missing | ForEach-Object { "- $_" } } else { '- (none)' })),
            '',
            '### recursive_search_run_all_local_then_copy.bat',
            ($searchResults['run_all_local_then_copy.bat'] | ForEach-Object { "- $_" }),
            '',
            '### recursive_search_package_diagnostics.ps1',
            ($searchResults['package_diagnostics.ps1'] | ForEach-Object { "- $_" }),
            '',
            '### recursive_search_package_diagnostics_to_onedrive.ps1',
            ($searchResults['package_diagnostics_to_onedrive.ps1'] | ForEach-Object { "- $_" }),
            '',
            '## NEXT_ACTION',
            '- Open Artifact desktop-run-* and copy ONE_TAP_ERROR_REPORT.txt'
          )

          if ($missing.Count -gt 0) {
            Write-Host '=== Required scripts debug summary ==='
            Write-Host "REPO_ROOT=$env:REPO_ROOT"
            Write-Host "scriptsDir=$scriptsDir"
            if (Test-Path $scriptsDir) {
              Write-Host 'scriptsDir listing:'
              Get-ChildItem -Path $scriptsDir | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
            }
            foreach ($fileName in $searchResults.Keys) {
              Write-Host "search($fileName):"
              $searchResults[$fileName] | ForEach-Object { Write-Host "  $_" }
            }
            $missingNames = $missing | ForEach-Object { Split-Path $_ -Leaf }
            throw ("Required scripts missing: {0}" -f (($missingNames | Sort-Object -Unique) -join ', '))
          }

      - name: Runner connectivity and host status
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          Write-Host '=== Runner connectivity / host status ==='
          whoami
          hostname
          Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz'
          Write-Host "RUNNER_NAME=$env:RUNNER_NAME"
          Write-Host "RUNNER_OS=$env:RUNNER_OS"
          Write-Host "RUNNER_ARCH=$env:RUNNER_ARCH"
          Write-Host "GITHUB_WORKFLOW=$env:GITHUB_WORKFLOW"
          Write-Host "GITHUB_RUN_ID=$env:GITHUB_RUN_ID"
          Get-Process | Where-Object { $_.Name -like '*Runner*' } |
            Select-Object Name, Id, StartTime |
            Format-Table -AutoSize

      - name: Run desktop BAT
        id: run_bat
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          INPUT_MODE: ${{ inputs.mode }}
          INPUT_SYMBOLS: ${{ inputs.symbols }}
          INPUT_START: ${{ inputs.start }}
          INPUT_END: ${{ inputs.end }}
          INPUT_TEST_START: ${{ inputs.test_start }}
          INPUT_TRAIN_YEARS: ${{ inputs.train_years }}
          INPUT_TEST_MONTHS: ${{ inputs.test_months }}
          INPUT_COPY_TO_ONEDRIVE: ${{ inputs.copy_to_onedrive }}
          INPUT_STEPS: ${{ inputs.steps }}
          RUN_MODE: ${{ inputs.mode }}
          SYMBOLS: ${{ inputs.symbols }}
          SYMBOL: SOXL
          STEPS: ${{ inputs.steps }}
          DATA_START: ${{ inputs.start }}
          DATA_END: ${{ inputs.end }}
          TEST_START: ${{ inputs.test_start }}
          TRAIN_YEARS: ${{ inputs.train_years }}
          TEST_MONTHS: ${{ inputs.test_months }}
          WORK_ROOT: C:\work\apex_work\runs
          COPY_TO_ONEDRIVE: ${{ inputs.copy_to_onedrive && '1' || '0' }}
          PYTHON_EXE: python
        run: |
          $ErrorActionPreference = 'Stop'
          Set-Location $env:REPO_ROOT
          $consoleLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'
          $batCandidates = @(
            (Join-Path $env:REPO_ROOT 'scripts\run_all_local_then_copy.bat')
          )
          $bat = $batCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          Write-Host '=== Run desktop BAT preflight ==='
          Write-Host "PWD=$PWD"
          Write-Host "REPO_ROOT=$env:REPO_ROOT"
          Write-Host "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          Write-Host "RUNNER_TEMP=$env:RUNNER_TEMP"
          Get-ChildItem (Join-Path $env:REPO_ROOT 'scripts') | Select-Object Name
          & where.exe python 2>$null
          Write-Host ("BAT candidate paths: {0}" -f ($batCandidates -join '; '))

          if (-not $bat) {
            Write-Error "BAT not found. candidates=$($batCandidates -join '; ')"
            exit 1
          }

          $bat = (Get-Item $bat).FullName
          Write-Host ("Executing BAT full path: {0}" -f $bat)

          $null = New-Item -Path $consoleLog -ItemType File -Force
          Add-Content -Path $consoleLog -Value ("[BAT_FULL_PATH]={0}" -f $bat)

          Write-Host '=== Python diagnostics (before BAT) ==='
          & where.exe python 2>&1 | Tee-Object -FilePath $consoleLog -Append
          & python --version 2>&1 | Tee-Object -FilePath $consoleLog -Append
          Write-Host '=== PATH (before BAT) ==='
          Write-Host $env:PATH
          Add-Content -Path $consoleLog -Value ('[PATH] ' + $env:PATH)

          & $bat 2>&1 | Tee-Object -FilePath $consoleLog -Append
          $rc = $LASTEXITCODE
          Write-Host "[RC]=$rc"
          Add-Content -Path $consoleLog -Value ("[RC]={0}" -f $rc)

          if ($rc -ne 0) {
            Write-Warning "Run desktop BAT failed with rc=$rc"
            $workRoot = 'C:\work\apex_work\runs'
            $runDir = $null
            if (Test-Path $workRoot) {
              $runDir = Get-ChildItem -Path $workRoot -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            }

            if ($runDir) {
              $runLog = Join-Path $runDir.FullName ("logs\run_{0}.log" -f $runDir.Name)
              Write-Host ("Latest run_dir={0}" -f $runDir.FullName)
              Write-Host ("Expected run_log={0}" -f $runLog)
              if (Test-Path $runLog) {
                Write-Host '=== tail run_*.log (260 lines) ==='
                Get-Content -Path $runLog -Tail 260
              } else {
                Write-Warning ("run log not found: {0}" -f $runLog)
              }
            } else {
              Write-Warning ("No run directories found under {0}" -f $workRoot)
            }
            exit $rc
          }

          exit 0

      - name: Stage console log in workspace
        if: always()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $workspaceTemp = Join-Path $env:GITHUB_WORKSPACE 'temp'
          $null = New-Item -Path $workspaceTemp -ItemType Directory -Force
          $consoleLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'
          $workspaceConsoleLog = Join-Path $workspaceTemp 'run_all_local_then_copy_console.log'
          if (Test-Path $consoleLog) {
            Copy-Item -Path $consoleLog -Destination $workspaceConsoleLog -Force
            Write-Host "Staged console log: $workspaceConsoleLog"
          } else {
            Write-Warning "Console log not found at: $consoleLog"
            @(
              '[WARN] Console log was not generated by BAT execution.',
              '[WARN] Never finish a workflow run without leaving a readable log artifact.',
              ('[WARN] generated_at={0}' -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz'))
            ) | Set-Content -Path $workspaceConsoleLog -Encoding UTF8
            Write-Host "Created fallback console log: $workspaceConsoleLog"
          }

      - name: Package diagnostics to OneDrive (always)
        if: always()
        id: package_diag
        continue-on-error: true
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          $diagScript = Join-Path $env:REPO_ROOT 'scripts\package_diagnostics_to_onedrive.ps1'
          Write-Host "Diagnostics script path: $diagScript"

          $diagDirCandidates = @()
          if ($env:OneDrive) {
            $diagDirCandidates += (Join-Path $env:OneDrive 'ApexTraderAI\diagnostics')
          }
          if ($env:USERPROFILE) {
            $diagDirCandidates += (Join-Path $env:USERPROFILE 'OneDrive\ApexTraderAI\diagnostics')
          }
          $diagDirCandidates += (Join-Path $env:RUNNER_TEMP 'ApexTraderAI\diagnostics')

          $selectedDiagDir = $null
          foreach ($candidate in $diagDirCandidates) {
            try {
              $null = New-Item -Path $candidate -ItemType Directory -Force -ErrorAction Stop
              $selectedDiagDir = $candidate
              break
            } catch {
              Write-Warning "Diagnostics dir candidate unavailable: $candidate ($($_.Exception.Message))"
            }
          }

          if (-not $selectedDiagDir) {
            throw 'Unable to resolve diagnostics output directory from OneDrive/USERPROFILE/RUNNER_TEMP candidates.'
          }

          Write-Host "Selected diagnostics output dir: $selectedDiagDir"
          "diag_dir=$selectedDiagDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          if (Test-Path $diagScript) {
            powershell -NoProfile -ExecutionPolicy Bypass -File $diagScript -DiagDir "$selectedDiagDir"
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Diagnostics script exited with code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
          } else {
            Write-Error "Diagnostics script not found: $diagScript"
            exit 1
          }

      - name: Verify diagnostics directory content
        if: always()
        continue-on-error: true
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          $diagDir = '${{ steps.package_diag.outputs.diag_dir }}'
          if (-not $diagDir) {
            $diagDir = Join-Path $env:RUNNER_TEMP 'ApexTraderAI\diagnostics'
          }
          Write-Host '=== diagnostics dir listing ==='
          if (Test-Path $diagDir) {
            dir $diagDir
          } else {
            Write-Warning "Diagnostics directory not found: $diagDir"
          }

          $latestZip = Get-ChildItem -Path $diagDir -File -Filter 'diag_*.zip' -ErrorAction SilentlyContinue |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $latestZip) {
            Write-Warning "diag zip missing in $diagDir"
            Write-Host 'Hint: package diagnostics step uses OneDrive -> USERPROFILE\\OneDrive -> RUNNER_TEMP fallback. Check step logs for selected path and creation errors.'
            exit 0
          }

          Write-Host "latestDiagZip=$($latestZip.FullName)"

      - name: Tail latest run log on failure
        if: failure()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $workRoot = 'C:\work\apex_work\runs'
          $latestRunLog = Get-ChildItem -Path (Join-Path $workRoot '*\logs\run_*.log') -File -ErrorAction SilentlyContinue |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if ($latestRunLog) {
            Write-Host ("=== latest run log: {0} ===" -f $latestRunLog.FullName)
            Write-Host '=== tail run_*.log (200 lines) ==='
            Get-Content -Path $latestRunLog.FullName -Tail 200
          } else {
            Write-Warning ("No run_*.log found under {0}" -f $workRoot)
          }

      - name: Resolve latest run artifacts
        if: always()
        id: resolve_artifacts
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $workRoot = 'C:\work\apex_work\runs'
          $consoleLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'

          $runId = ''
          if (Test-Path $consoleLog) {
            $runIdLine = Select-String -Path $consoleLog -Pattern '^\[OK\] run_id=' | Select-Object -Last 1
            if ($runIdLine) {
              $runId = ($runIdLine.Line -replace '^\[OK\] run_id=', '').Trim()
            }
          }

          $runDir = $null
          if ($runId) {
            $candidateDir = Join-Path $workRoot $runId
            if (Test-Path $candidateDir) {
              $runDir = Get-Item $candidateDir
            }
          }

          if (-not $runDir -and (Test-Path $workRoot)) {
            $runDir = Get-ChildItem -Path $workRoot -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if ($runDir -and -not $runId) {
              $runId = $runDir.Name
            }
          }

          if ($runId) {
            "run_id=$runId" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "Resolved run_id=$runId"
          } else {
            Write-Warning 'Failed to resolve run_id from console log and latest run folder.'
          }

          if ($runDir) {
            $logGlob = Join-Path $runDir.FullName 'logs\run_*.log'
            $zipPath = Join-Path $runDir.FullName ("run_{0}.zip" -f $runDir.Name)
            $runLogPath = Join-Path $runDir.FullName ("logs\run_{0}.log" -f $runDir.Name)
            "log_glob=$logGlob" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "run_log_path=$runLogPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "run_dir=$($runDir.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "Resolved run directory: $($runDir.FullName)"
          }

      - name: Stage run artifacts
        if: always()
        id: stage_artifacts
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $artifactRoot = Join-Path $env:GITHUB_WORKSPACE 'temp\desktop_artifacts'
          $null = New-Item -Path $artifactRoot -ItemType Directory -Force
          $workspaceLogRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\logs'
          $null = New-Item -Path $workspaceLogRoot -ItemType Directory -Force

          $reportSource = Join-Path $env:GITHUB_WORKSPACE 'temp\ONE_TAP_ERROR_REPORT.txt'
          $reportDest = Join-Path $artifactRoot 'ONE_TAP_ERROR_REPORT.txt'
          if (Test-Path $reportSource) {
            Copy-Item -Path $reportSource -Destination $reportDest -Force
          } else {
            @(
              '[WARN] ONE_TAP_ERROR_REPORT.txt was missing at stage time.',
              ('timestamp={0}' -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz'))
            ) | Set-Content -Path $reportDest -Encoding UTF8
          }

          $consoleLog = Join-Path $env:GITHUB_WORKSPACE 'temp\run_all_local_then_copy_console.log'
          if (Test-Path $consoleLog) {
            Copy-Item -Path $consoleLog -Destination (Join-Path $artifactRoot 'run_all_local_then_copy_console.log') -Force
          }

          $runLog = '${{ steps.resolve_artifacts.outputs.run_log_path }}'
          if ((-not $runLog) -or (-not (Test-Path $runLog))) {
            $runDir = '${{ steps.resolve_artifacts.outputs.run_dir }}'
            if ($runDir -and (Test-Path $runDir)) {
              $latestRunLog = Get-ChildItem -Path (Join-Path $runDir 'logs') -Filter 'run_*.log' -File -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              if ($latestRunLog) {
                $runLog = $latestRunLog.FullName
              }
            }
          }

          if ($runLog -and (Test-Path $runLog)) {
            $runLogName = Split-Path -Path $runLog -Leaf
            Copy-Item -Path $runLog -Destination (Join-Path $artifactRoot $runLogName) -Force
            Copy-Item -Path $runLog -Destination (Join-Path $workspaceLogRoot $runLogName) -Force
            Write-Host "Staged run log: $runLog"
          } else {
            Write-Warning 'Run log was not found for artifact staging. Uploading console log artifact only.'
            @(
              '[WARN] run_*.log was not found. Artifact includes console log only.',
              '[WARN] Never finish a workflow run without leaving a readable log artifact.',
              ('[WARN] generated_at={0}' -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz'))
            ) | Set-Content -Path (Join-Path $artifactRoot 'missing_run_log_warning.txt') -Encoding UTF8
          }

          $zipPath = '${{ steps.resolve_artifacts.outputs.zip_path }}'
          if ($zipPath -and (Test-Path $zipPath)) {
            Copy-Item -Path $zipPath -Destination (Join-Path $artifactRoot (Split-Path -Path $zipPath -Leaf)) -Force
          }

          "artifact_path=$artifactRoot" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Staged artifacts under: $artifactRoot"

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-run-${{ steps.resolve_artifacts.outputs.run_id || github.run_id }}
          if-no-files-found: warn
          path: ${{ steps.stage_artifacts.outputs.artifact_path }}\**

      - name: Publish ONE_TAP report to diag-logs branch
        if: always()
        continue-on-error: true
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'

          $diagRepo = Join-Path $env:RUNNER_TEMP 'diag_repo'
          if (Test-Path $diagRepo) { Remove-Item -Path $diagRepo -Recurse -Force }
          $null = New-Item -Path $diagRepo -ItemType Directory -Force
          Set-Location $diagRepo

          git init
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"

          git fetch origin diag-logs --depth 1 2>$null
          if ($LASTEXITCODE -eq 0) {
            git checkout -B diag-logs origin/diag-logs
          } else {
            git checkout --orphan diag-logs
          }

          $runsDir = Join-Path $diagRepo 'runs'
          $null = New-Item -Path $runsDir -ItemType Directory -Force

          $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
          $shortSha = ('${{ github.sha }}').Substring(0, 7)
          $runFolderName = "${timestamp}_run${{ github.run_id }}_att${{ github.run_attempt }}_${shortSha}"
          $runFolder = Join-Path $runsDir $runFolderName
          $null = New-Item -Path $runFolder -ItemType Directory -Force

          $oneTapSource = Join-Path $env:GITHUB_WORKSPACE 'temp\ONE_TAP_ERROR_REPORT.txt'
          $oneTapDest = Join-Path $runFolder 'ONE_TAP_ERROR_REPORT.txt'
          if (Test-Path $oneTapSource) {
            Copy-Item -Path $oneTapSource -Destination $oneTapDest -Force
          } else {
            @(
              '[WARN] ONE_TAP_ERROR_REPORT.txt was not found in workspace temp.',
              ('timestamp={0}' -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz')),
              ('repo=${{ github.repository }}'),
              ('run_id=${{ github.run_id }}'),
              ('run_attempt=${{ github.run_attempt }}')
            ) | Set-Content -Path $oneTapDest -Encoding UTF8
          }

          $latestMdPath = Join-Path $runsDir 'LATEST.md'
          @(
            '# Latest ONE_TAP report',
            '',
            "- folder: $runFolderName",
            "- report: ./runs/$runFolderName/ONE_TAP_ERROR_REPORT.txt"
          ) -join "`r`n" | Set-Content -Path $latestMdPath -Encoding UTF8

          git add runs
          if (git diff --cached --quiet) {
            Write-Host 'No diagnostics changes to commit.'
            exit 0
          }

          git commit -m "diag: add one_tap report $runFolderName"
          git push origin diag-logs
          if ($LASTEXITCODE -ne 0) {
            Write-Warning 'Failed to push ONE_TAP report to diag-logs branch.'
            Write-Warning 'Enable Settings > Actions > Workflow permissions: Read and write permissions'
            exit $LASTEXITCODE
          }

      - name: Collect diagnostics
        if: always()
        id: collect_diag
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          FAILING_STEP: ${{ steps.run_bat.outcome != 'success' && 'Run desktop BAT' || 'unknown' }}
        run: |
          $ErrorActionPreference = 'Stop'

          function Mask-Secrets {
            param([string]$Text)

            if ([string]::IsNullOrEmpty($Text)) { return $Text }

            $masked = $Text
            $masked = [regex]::Replace($masked, 'github_pat_[A-Za-z0-9_]{20,}', 'github_pat_***MASKED***')
            $masked = [regex]::Replace($masked, 'gh[pousr]_[A-Za-z0-9_]{20,}', 'gh***_***MASKED***')
            $masked = [regex]::Replace($masked, '(?im)\b(token|password|secret)\b\s*[:=]\s*\S+', '$1=***MASKED***')
            return $masked
          }

          function Get-MaskedTail {
            param(
              [string]$Path,
              [int]$Tail = 200
            )

            if (-not (Test-Path $Path)) { return "(not found) $Path" }
            $raw = (Get-Content -Path $Path -Tail $Tail -ErrorAction SilentlyContinue) -join "`r`n"
            return (Mask-Secrets -Text $raw)
          }

          $diagOut = Join-Path $env:RUNNER_TEMP 'diag_out'
          $null = New-Item -Path $diagOut -ItemType Directory -Force

          $ws = $env:GITHUB_WORKSPACE
          $runnerRoot = (Resolve-Path (Join-Path $ws '..\..\..')).Path
          $runnerDiag = Join-Path $runnerRoot '_diag'
          $runId = '${{ github.run_id }}'
          $runAttempt = '${{ github.run_attempt }}'
          $sha = '${{ github.sha }}'
          $branch = '${{ github.ref_name }}'
          $repo = '${{ github.repository }}'
          $artifactName = "diag_full_${runId}_${runAttempt}"

          $latestRunnerLog = $null
          $latestWorkerLog = $null
          if (Test-Path $runnerDiag) {
            $latestRunnerLog = Get-ChildItem -Path $runnerDiag -Filter 'Runner_*.log' -File -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            $latestWorkerLog = Get-ChildItem -Path $runnerDiag -Filter 'Worker_*.log' -File -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          }

          $workflowLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'
          $runLogPath = '${{ steps.resolve_artifacts.outputs.run_log_path }}'
          $stepSummaryGlob = Join-Path $env:RUNNER_TEMP 'step_summary_*'
          $oneTapReportWorkspace = Join-Path $env:GITHUB_WORKSPACE 'temp\ONE_TAP_ERROR_REPORT.txt'

          if ($latestRunnerLog) { Copy-Item -Path $latestRunnerLog.FullName -Destination (Join-Path $diagOut $latestRunnerLog.Name) -Force }
          if ($latestWorkerLog) { Copy-Item -Path $latestWorkerLog.FullName -Destination (Join-Path $diagOut $latestWorkerLog.Name) -Force }
          if (Test-Path $workflowLog) { Copy-Item -Path $workflowLog -Destination (Join-Path $diagOut 'workflow_console.log') -Force }
          if ($runLogPath -and (Test-Path $runLogPath)) { Copy-Item -Path $runLogPath -Destination (Join-Path $diagOut (Split-Path $runLogPath -Leaf)) -Force }
          if (Test-Path $oneTapReportWorkspace) { Copy-Item -Path $oneTapReportWorkspace -Destination (Join-Path $diagOut 'ONE_TAP_ERROR_REPORT.txt') -Force }
          Get-ChildItem -Path $stepSummaryGlob -File -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item -Path $_.FullName -Destination (Join-Path $diagOut $_.Name) -Force
          }

          foreach ($subDir in @('pages', 'blocks')) {
            $src = Join-Path $runnerDiag $subDir
            if (Test-Path $src) {
              Copy-Item -Path $src -Destination (Join-Path $diagOut $subDir) -Recurse -Force
            }
          }

          $runnerTailText = if ($latestRunnerLog) { Get-MaskedTail -Path $latestRunnerLog.FullName -Tail 200 } else { '(runner diag not found)' }
          $workflowTailText = if (Test-Path $workflowLog) { Get-MaskedTail -Path $workflowLog -Tail 200 } else { '(workflow log not found)' }

          $summaryPath = Join-Path $diagOut 'summary.md'
          $summary = @(
            '# Diagnostics Summary',
            '',
            "- repo: $repo",
            "- branch: $branch",
            "- sha: $sha",
            "- run_id: $runId",
            "- attempt: $runAttempt",
            "- failing_step: $env:FAILING_STEP",
            "- artifact_name: $artifactName",
            '- one_tap_report: See ONE_TAP_ERROR_REPORT.txt',
            '',
            '## runner_diag_tail (last 200 lines)',
            '```text',
            $runnerTailText,
            '```',
            '',
            '## workflow_tail (last 200 lines)',
            '```text',
            $workflowTailText,
            '```'
          ) -join "`r`n"
          $summary = Mask-Secrets -Text $summary
          Set-Content -Path $summaryPath -Value $summary -Encoding UTF8

          $runnerTailPath = Join-Path $diagOut 'runner_diag_tail.txt'
          Set-Content -Path $runnerTailPath -Value $runnerTailText -Encoding UTF8
          $workflowTailPath = Join-Path $diagOut 'workflow_tail.txt'
          Set-Content -Path $workflowTailPath -Value $workflowTailText -Encoding UTF8

          $fullZip = Join-Path $env:RUNNER_TEMP ("{0}.zip" -f $artifactName)
          if (Test-Path $fullZip) { Remove-Item $fullZip -Force }
          Compress-Archive -Path (Join-Path $diagOut '*') -DestinationPath $fullZip -Force

          "diag_out=$diagOut" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_summary=$summaryPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_runner_tail=$runnerTailPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_workflow_tail=$workflowTailPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_zip=$fullZip" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_artifact_name=$artifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload full diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.collect_diag.outputs.diag_artifact_name }}
          if-no-files-found: warn
          retention-days: 7
          path: ${{ steps.collect_diag.outputs.diag_zip }}


      - name: Upload diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics
          if-no-files-found: warn
          path: _diagnostics/**/*
