name: Run Desktop Pipeline

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Pipeline mode (sim/live/display)"
        required: true
        default: sim
        type: choice
        options:
          - sim
          - live
          - display
      symbols:
        description: "Symbols for data preparation (comma-separated)"
        required: true
        default: "SOXL,SOXS"
        type: string
      start:
        description: "Data start date (YYYY-MM-DD)"
        required: true
        default: "2014-01-01"
        type: string
      end:
        description: "Data end date (YYYY-MM-DD)"
        required: true
        default: "2022-03-31"
        type: string
      test_start:
        description: "Test start date (YYYY-MM-DD)"
        required: true
        default: "2022-01-03"
        type: string
      train_years:
        description: "Train years"
        required: true
        default: "8"
        type: string
      test_months:
        description: "Test months"
        required: true
        default: "3"
        type: string
      copy_to_onedrive:
        description: "Reserved for future BAT integration"
        required: true
        default: true
        type: boolean

concurrency:
  group: diag-logs
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: [self-hosted, windows]
    steps:
      - name: Sync repo to github.sha (no delete)
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          GIT_TERMINAL_PROMPT: "0"
        run: |
          $ErrorActionPreference = 'Stop'
          $repo = "$env:GITHUB_WORKSPACE"
          Set-Location $repo

          git config --global core.longpaths true
          git config --global --add safe.directory "$repo"

          if (!(Test-Path (Join-Path $repo '.git'))) {
            git init
            git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          } else {
            git remote get-url origin *> $null
            if ($LASTEXITCODE -ne 0) {
              git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
            } else {
              git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" | Out-Null
            }
          }

          git fetch --force --prune origin
          git checkout -f $env:GITHUB_SHA
          git reset --hard $env:GITHUB_SHA
          git clean -ffdx
          if (Test-Path (Join-Path $env:GITHUB_WORKSPACE '.gitmodules')) {
            git submodule update --init --recursive
          }
          git rev-parse HEAD

      - name: Debug shells
        continue-on-error: true
        shell: cmd
        run: |
          echo RUNNER_OS=%RUNNER_OS%
          echo === powershell path ===
          where powershell >nul 2>&1
          if %ERRORLEVEL% EQU 0 (
            where powershell
          ) else (
            echo powershell_not_found
          )
          echo === pwsh path (optional) ===
          where pwsh >nul 2>&1
          if %ERRORLEVEL% EQU 0 (
            pwsh -v
          ) else (
            echo pwsh_not_found (OK)
          )
          exit /b 0

      - name: Debug python environment
        shell: cmd
        run: |
          where python
          python --version
          echo RUNNER_TEMP=%RUNNER_TEMP%
          echo GITHUB_WORKSPACE=%GITHUB_WORKSPACE%

      - name: Verify required scripts
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          Set-Location $env:GITHUB_WORKSPACE

          Write-Host '=== Verify scripts directory ==='
          $scriptsDir = Join-Path $env:GITHUB_WORKSPACE 'scripts'
          Write-Host "scripts_dir=$scriptsDir"
          if (Test-Path $scriptsDir) {
            Get-ChildItem -Path $scriptsDir | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          } else {
            Write-Error "scripts directory not found: $scriptsDir"
          }

          $expected = @(
            (Join-Path $env:GITHUB_WORKSPACE 'scripts\run_all_local_then_copy.bat'),
            (Join-Path $env:GITHUB_WORKSPACE 'scripts\package_diagnostics.ps1'),
            (Join-Path $env:GITHUB_WORKSPACE 'scripts\package_diagnostics_to_onedrive.ps1')
          )

          $missing = @()
          foreach ($path in $expected) {
            if (Test-Path $path) {
              Write-Host "[FOUND] $path"
            } else {
              Write-Error "[MISSING] $path"
              $missing += $path
            }
          }

          if ($missing.Count -gt 0) {
            throw ("Required scripts missing: {0}" -f ($missing -join ', '))
          }

      - name: Runner connectivity and host status
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          Write-Host '=== Runner connectivity / host status ==='
          whoami
          hostname
          Get-Date -Format 'yyyy-MM-dd HH:mm:ss zzz'
          Write-Host "RUNNER_NAME=$env:RUNNER_NAME"
          Write-Host "RUNNER_OS=$env:RUNNER_OS"
          Write-Host "RUNNER_ARCH=$env:RUNNER_ARCH"
          Write-Host "GITHUB_WORKFLOW=$env:GITHUB_WORKFLOW"
          Write-Host "GITHUB_RUN_ID=$env:GITHUB_RUN_ID"
          Get-Process | Where-Object { $_.Name -like '*Runner*' } |
            Select-Object Name, Id, StartTime |
            Format-Table -AutoSize

      - name: Run desktop BAT
        id: run_bat
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          INPUT_MODE: ${{ inputs.mode }}
          INPUT_SYMBOLS: ${{ inputs.symbols }}
          INPUT_START: ${{ inputs.start }}
          INPUT_END: ${{ inputs.end }}
          INPUT_TEST_START: ${{ inputs.test_start }}
          INPUT_TRAIN_YEARS: ${{ inputs.train_years }}
          INPUT_TEST_MONTHS: ${{ inputs.test_months }}
          INPUT_COPY_TO_ONEDRIVE: ${{ inputs.copy_to_onedrive }}
          RUN_MODE: ${{ inputs.mode }}
          SYMBOLS: ${{ inputs.symbols }}
          DATA_START: ${{ inputs.start }}
          DATA_END: ${{ inputs.end }}
          TEST_START: ${{ inputs.test_start }}
          TRAIN_YEARS: ${{ inputs.train_years }}
          TEST_MONTHS: ${{ inputs.test_months }}
          PYTHON_EXE: python
        run: |
          $ErrorActionPreference = 'Stop'
          Set-Location $env:GITHUB_WORKSPACE
          $consoleLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'
          $batCandidates = @(
            (Join-Path $env:GITHUB_WORKSPACE 'scripts\run_all_local_then_copy.bat')
          )
          $bat = $batCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          Write-Host '=== Run desktop BAT preflight ==='
          Write-Host "PWD=$PWD"
          Write-Host "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          Write-Host "RUNNER_TEMP=$env:RUNNER_TEMP"
          Get-ChildItem (Join-Path $env:GITHUB_WORKSPACE 'scripts') | Select-Object Name
          & where.exe python 2>$null
          Write-Host ("BAT candidate paths: {0}" -f ($batCandidates -join '; '))

          if (-not $bat) {
            Write-Error "BAT not found. candidates=$($batCandidates -join '; ')"
            exit 1
          }

          $bat = (Get-Item $bat).FullName
          Write-Host ("Executing BAT full path: {0}" -f $bat)

          $null = New-Item -Path $consoleLog -ItemType File -Force
          Add-Content -Path $consoleLog -Value ("[BAT_FULL_PATH]={0}" -f $bat)

          Write-Host '=== Python diagnostics (before BAT) ==='
          & where.exe python 2>&1 | Tee-Object -FilePath $consoleLog -Append
          & python --version 2>&1 | Tee-Object -FilePath $consoleLog -Append
          Write-Host '=== PATH (before BAT) ==='
          Write-Host $env:PATH
          Add-Content -Path $consoleLog -Value ('[PATH] ' + $env:PATH)

          & $bat 2>&1 | Tee-Object -FilePath $consoleLog -Append
          $rc = $LASTEXITCODE
          Write-Host "[RC]=$rc"
          Add-Content -Path $consoleLog -Value ("[RC]={0}" -f $rc)

          if ($rc -ne 0) {
            Write-Warning "Run desktop BAT failed with rc=$rc"
            $workRoot = 'C:\work\apex_work\runs'
            $runDir = $null
            if (Test-Path $workRoot) {
              $runDir = Get-ChildItem -Path $workRoot -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            }

            if ($runDir) {
              $runLog = Join-Path $runDir.FullName ("logs\run_{0}.log" -f $runDir.Name)
              Write-Host ("Latest run_dir={0}" -f $runDir.FullName)
              Write-Host ("Expected run_log={0}" -f $runLog)
              if (Test-Path $runLog) {
                Write-Host '=== tail run_*.log (260 lines) ==='
                Get-Content -Path $runLog -Tail 260
              } else {
                Write-Warning ("run log not found: {0}" -f $runLog)
              }
            } else {
              Write-Warning ("No run directories found under {0}" -f $workRoot)
            }
            exit $rc
          }

          exit 0

      - name: Stage console log in workspace
        if: always()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $workspaceTemp = Join-Path $env:GITHUB_WORKSPACE 'temp'
          $null = New-Item -Path $workspaceTemp -ItemType Directory -Force
          $consoleLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'
          $workspaceConsoleLog = Join-Path $workspaceTemp 'run_all_local_then_copy_console.log'
          if (Test-Path $consoleLog) {
            Copy-Item -Path $consoleLog -Destination $workspaceConsoleLog -Force
            Write-Host "Staged console log: $workspaceConsoleLog"
          } else {
            Write-Warning "Console log not found at: $consoleLog"
          }

      - name: Package diagnostics to OneDrive (always)
        if: always()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          $diagScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\package_diagnostics_to_onedrive.ps1'
          $diagDir = 'C:\Users\becky\OneDrive\ApexTraderAI\diagnostics'
          Write-Host "Diagnostics script path: $diagScript"
          Write-Host "Diagnostics fixed output dir: $diagDir"

          if (Test-Path $diagScript) {
            powershell -NoProfile -ExecutionPolicy Bypass -File scripts\package_diagnostics_to_onedrive.ps1 -DiagDir 'C:\Users\becky\OneDrive\ApexTraderAI\diagnostics'
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Diagnostics script exited with code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
          } else {
            Write-Error "Diagnostics script not found: $diagScript"
            exit 1
          }

      - name: Verify diagnostics directory content
        if: always()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $ErrorActionPreference = 'Stop'
          $diagDir = 'C:\Users\becky\OneDrive\ApexTraderAI\diagnostics'
          Write-Host '=== diagnostics dir listing ==='
          dir "C:\Users\becky\OneDrive\ApexTraderAI\diagnostics"

          $latestZip = Get-ChildItem -Path $diagDir -File -Filter 'diag_*.zip' -ErrorAction SilentlyContinue |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $latestZip) {
            Write-Error "diag zip missing in $diagDir"
            exit 1
          }

          Write-Host "latestDiagZip=$($latestZip.FullName)"

      - name: Tail latest run log on failure
        if: failure()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $workRoot = 'C:\work\apex_work\runs'
          $latestRunLog = Get-ChildItem -Path (Join-Path $workRoot '*\logs\run_*.log') -File -ErrorAction SilentlyContinue |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if ($latestRunLog) {
            Write-Host ("=== latest run log: {0} ===" -f $latestRunLog.FullName)
            Write-Host '=== tail run_*.log (200 lines) ==='
            Get-Content -Path $latestRunLog.FullName -Tail 200
          } else {
            Write-Warning ("No run_*.log found under {0}" -f $workRoot)
          }

      - name: Resolve latest run artifacts
        if: always()
        id: resolve_artifacts
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $workRoot = 'C:\work\apex_work\runs'
          $consoleLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'

          $runId = ''
          if (Test-Path $consoleLog) {
            $runIdLine = Select-String -Path $consoleLog -Pattern '^\[OK\] run_id=' | Select-Object -Last 1
            if ($runIdLine) {
              $runId = ($runIdLine.Line -replace '^\[OK\] run_id=', '').Trim()
            }
          }

          $runDir = $null
          if ($runId) {
            $candidateDir = Join-Path $workRoot $runId
            if (Test-Path $candidateDir) {
              $runDir = Get-Item $candidateDir
            }
          }

          if (-not $runDir -and (Test-Path $workRoot)) {
            $runDir = Get-ChildItem -Path $workRoot -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if ($runDir -and -not $runId) {
              $runId = $runDir.Name
            }
          }

          if ($runId) {
            "run_id=$runId" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "Resolved run_id=$runId"
          } else {
            Write-Warning 'Failed to resolve run_id from console log and latest run folder.'
          }

          if ($runDir) {
            $logGlob = Join-Path $runDir.FullName 'logs\run_*.log'
            $zipPath = Join-Path $runDir.FullName ("run_{0}.zip" -f $runDir.Name)
            $runLogPath = Join-Path $runDir.FullName ("logs\run_{0}.log" -f $runDir.Name)
            "log_glob=$logGlob" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "run_log_path=$runLogPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "run_dir=$($runDir.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "Resolved run directory: $($runDir.FullName)"
          }

      - name: Stage run artifacts
        if: always()
        id: stage_artifacts
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        run: |
          $artifactRoot = Join-Path $env:GITHUB_WORKSPACE 'temp\desktop_artifacts'
          $null = New-Item -Path $artifactRoot -ItemType Directory -Force
          $workspaceLogRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\logs'
          $null = New-Item -Path $workspaceLogRoot -ItemType Directory -Force

          $consoleLog = Join-Path $env:GITHUB_WORKSPACE 'temp\run_all_local_then_copy_console.log'
          if (Test-Path $consoleLog) {
            Copy-Item -Path $consoleLog -Destination (Join-Path $artifactRoot 'run_all_local_then_copy_console.log') -Force
          }

          $runLog = '${{ steps.resolve_artifacts.outputs.run_log_path }}'
          if ((-not $runLog) -or (-not (Test-Path $runLog))) {
            $runDir = '${{ steps.resolve_artifacts.outputs.run_dir }}'
            if ($runDir -and (Test-Path $runDir)) {
              $latestRunLog = Get-ChildItem -Path (Join-Path $runDir 'logs') -Filter 'run_*.log' -File -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              if ($latestRunLog) {
                $runLog = $latestRunLog.FullName
              }
            }
          }

          if ($runLog -and (Test-Path $runLog)) {
            $runLogName = Split-Path -Path $runLog -Leaf
            Copy-Item -Path $runLog -Destination (Join-Path $artifactRoot $runLogName) -Force
            Copy-Item -Path $runLog -Destination (Join-Path $workspaceLogRoot $runLogName) -Force
            Write-Host "Staged run log: $runLog"
          } else {
            Write-Warning 'Run log was not found for artifact staging.'
          }

          $zipPath = '${{ steps.resolve_artifacts.outputs.zip_path }}'
          if ($zipPath -and (Test-Path $zipPath)) {
            Copy-Item -Path $zipPath -Destination (Join-Path $artifactRoot (Split-Path -Path $zipPath -Leaf)) -Force
          }

          "artifact_path=$artifactRoot" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Staged artifacts under: $artifactRoot"

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-run-${{ steps.resolve_artifacts.outputs.run_id || github.run_id }}
          if-no-files-found: warn
          path: ${{ steps.stage_artifacts.outputs.artifact_path }}\**

      - name: Collect diagnostics
        if: always()
        id: collect_diag
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          FAILING_STEP: ${{ steps.run_bat.outcome != 'success' && 'Run desktop BAT' || 'unknown' }}
        run: |
          $ErrorActionPreference = 'Stop'

          function Mask-Secrets {
            param([string]$Text)

            if ([string]::IsNullOrEmpty($Text)) { return $Text }

            $masked = $Text
            $masked = [regex]::Replace($masked, 'github_pat_[A-Za-z0-9_]{20,}', 'github_pat_***MASKED***')
            $masked = [regex]::Replace($masked, 'gh[pousr]_[A-Za-z0-9_]{20,}', 'gh***_***MASKED***')
            $masked = [regex]::Replace($masked, '(?im)\b(token|password|secret)\b\s*[:=]\s*\S+', '$1=***MASKED***')
            return $masked
          }

          function Get-MaskedTail {
            param(
              [string]$Path,
              [int]$Tail = 200
            )

            if (-not (Test-Path $Path)) { return "(not found) $Path" }
            $raw = (Get-Content -Path $Path -Tail $Tail -ErrorAction SilentlyContinue) -join "`r`n"
            return (Mask-Secrets -Text $raw)
          }

          $diagOut = Join-Path $env:RUNNER_TEMP 'diag_out'
          $null = New-Item -Path $diagOut -ItemType Directory -Force

          $ws = $env:GITHUB_WORKSPACE
          $runnerRoot = (Resolve-Path (Join-Path $ws '..\..\..')).Path
          $runnerDiag = Join-Path $runnerRoot '_diag'
          $runId = '${{ github.run_id }}'
          $runAttempt = '${{ github.run_attempt }}'
          $sha = '${{ github.sha }}'
          $branch = '${{ github.ref_name }}'
          $repo = '${{ github.repository }}'
          $artifactName = "diag_full_${runId}_${runAttempt}"

          $latestRunnerLog = $null
          $latestWorkerLog = $null
          if (Test-Path $runnerDiag) {
            $latestRunnerLog = Get-ChildItem -Path $runnerDiag -Filter 'Runner_*.log' -File -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            $latestWorkerLog = Get-ChildItem -Path $runnerDiag -Filter 'Worker_*.log' -File -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          }

          $workflowLog = Join-Path $env:RUNNER_TEMP 'run_all_local_then_copy_console.log'
          $runLogPath = '${{ steps.resolve_artifacts.outputs.run_log_path }}'
          $stepSummaryGlob = Join-Path $env:RUNNER_TEMP 'step_summary_*'

          if ($latestRunnerLog) { Copy-Item -Path $latestRunnerLog.FullName -Destination (Join-Path $diagOut $latestRunnerLog.Name) -Force }
          if ($latestWorkerLog) { Copy-Item -Path $latestWorkerLog.FullName -Destination (Join-Path $diagOut $latestWorkerLog.Name) -Force }
          if (Test-Path $workflowLog) { Copy-Item -Path $workflowLog -Destination (Join-Path $diagOut 'workflow_console.log') -Force }
          if ($runLogPath -and (Test-Path $runLogPath)) { Copy-Item -Path $runLogPath -Destination (Join-Path $diagOut (Split-Path $runLogPath -Leaf)) -Force }
          Get-ChildItem -Path $stepSummaryGlob -File -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item -Path $_.FullName -Destination (Join-Path $diagOut $_.Name) -Force
          }

          foreach ($subDir in @('pages', 'blocks')) {
            $src = Join-Path $runnerDiag $subDir
            if (Test-Path $src) {
              Copy-Item -Path $src -Destination (Join-Path $diagOut $subDir) -Recurse -Force
            }
          }

          $runnerTailText = if ($latestRunnerLog) { Get-MaskedTail -Path $latestRunnerLog.FullName -Tail 200 } else { '(runner diag not found)' }
          $workflowTailText = if (Test-Path $workflowLog) { Get-MaskedTail -Path $workflowLog -Tail 200 } else { '(workflow log not found)' }

          $summaryPath = Join-Path $diagOut 'summary.md'
          $summary = @(
            '# Diagnostics Summary',
            '',
            "- repo: $repo",
            "- branch: $branch",
            "- sha: $sha",
            "- run_id: $runId",
            "- attempt: $runAttempt",
            "- failing_step: $env:FAILING_STEP",
            "- artifact_name: $artifactName",
            '',
            '## runner_diag_tail (last 200 lines)',
            '```text',
            $runnerTailText,
            '```',
            '',
            '## workflow_tail (last 200 lines)',
            '```text',
            $workflowTailText,
            '```'
          ) -join "`r`n"
          $summary = Mask-Secrets -Text $summary
          Set-Content -Path $summaryPath -Value $summary -Encoding UTF8

          $runnerTailPath = Join-Path $diagOut 'runner_diag_tail.txt'
          Set-Content -Path $runnerTailPath -Value $runnerTailText -Encoding UTF8
          $workflowTailPath = Join-Path $diagOut 'workflow_tail.txt'
          Set-Content -Path $workflowTailPath -Value $workflowTailText -Encoding UTF8

          $fullZip = Join-Path $env:RUNNER_TEMP ("{0}.zip" -f $artifactName)
          if (Test-Path $fullZip) { Remove-Item $fullZip -Force }
          Compress-Archive -Path (Join-Path $diagOut '*') -DestinationPath $fullZip -Force

          "diag_out=$diagOut" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_summary=$summaryPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_runner_tail=$runnerTailPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_workflow_tail=$workflowTailPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_zip=$fullZip" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "diag_artifact_name=$artifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload full diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.collect_diag.outputs.diag_artifact_name }}
          if-no-files-found: warn
          retention-days: 7
          path: ${{ steps.collect_diag.outputs.diag_zip }}

      - name: Publish lightweight diagnostics to diag-logs branch
        if: always()
        shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"
        env:
          KEEP_LATEST: '30'
        run: |
          $ErrorActionPreference = 'Stop'

          $diagRepo = Join-Path $env:RUNNER_TEMP 'diag_repo'
          if (Test-Path $diagRepo) { Remove-Item -Path $diagRepo -Recurse -Force }
          $null = New-Item -Path $diagRepo -ItemType Directory -Force
          Set-Location $diagRepo

          git init
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"

          git fetch origin diag-logs --depth 1 2>$null
          if ($LASTEXITCODE -eq 0) {
            git checkout -B diag-logs origin/diag-logs
          } else {
            git checkout --orphan diag-logs
            if (Test-Path '.gitignore') { Remove-Item '.gitignore' -Force }
          }

          $runsDir = Join-Path $diagRepo 'runs'
          $null = New-Item -Path $runsDir -ItemType Directory -Force

          $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
          $shortSha = ('${{ github.sha }}').Substring(0, 7)
          $runFolderName = "${timestamp}_run${{ github.run_id }}_att${{ github.run_attempt }}_${shortSha}"
          $runFolder = Join-Path $runsDir $runFolderName
          $null = New-Item -Path $runFolder -ItemType Directory -Force

          Copy-Item -Path '${{ steps.collect_diag.outputs.diag_summary }}' -Destination (Join-Path $runFolder 'summary.md') -Force
          Copy-Item -Path '${{ steps.collect_diag.outputs.diag_runner_tail }}' -Destination (Join-Path $runFolder 'runner_diag_tail.txt') -Force
          Copy-Item -Path '${{ steps.collect_diag.outputs.diag_workflow_tail }}' -Destination (Join-Path $runFolder 'workflow_tail.txt') -Force

          $latestMdPath = Join-Path $runsDir 'LATEST.md'
          @(
            '# Latest diagnostics run',
            '',
            "- folder: $runFolderName",
            "- summary: ./runs/$runFolderName/summary.md",
            "- runner_diag_tail: ./runs/$runFolderName/runner_diag_tail.txt",
            "- workflow_tail: ./runs/$runFolderName/workflow_tail.txt"
          ) -join "`r`n" | Set-Content -Path $latestMdPath -Encoding UTF8

          $keepLatest = [int]$env:KEEP_LATEST
          $runDirs = Get-ChildItem -Path $runsDir -Directory | Sort-Object Name -Descending
          if ($runDirs.Count -gt $keepLatest) {
            $toDelete = $runDirs | Select-Object -Skip $keepLatest
            foreach ($dir in $toDelete) {
              Remove-Item -Path $dir.FullName -Recurse -Force
            }
          }

          $currentRuns = Get-ChildItem -Path $runsDir -Directory | Sort-Object Name -Descending | ForEach-Object {
            [PSCustomObject]@{
              folder = $_.Name
              updated_utc = $_.LastWriteTimeUtc.ToString('o')
            }
          }
          $indexPath = Join-Path $runsDir 'index.json'
          $currentRuns | ConvertTo-Json -Depth 3 | Set-Content -Path $indexPath -Encoding UTF8

          git add runs
          if (git diff --cached --quiet) {
            Write-Host 'No diagnostics changes to commit.'
            exit 0
          }

          git commit -m "diag: add run $runFolderName"
          git push origin diag-logs

      - name: Upload diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics
          if-no-files-found: warn
          path: _diagnostics/**/*
